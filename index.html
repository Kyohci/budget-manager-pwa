<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Manager Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestisci il tuo budget mensile e settimanale con facilit√†">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Budget Manager">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            overflow-x: hidden; 
            font-size: 14px;
        }
        
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-content {
            text-align: center;
            position: relative;
            animation: splashPulse 2s ease-in-out infinite;
        }
        
        .splash-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: logoFloat 3s ease-in-out infinite, logoBubble 4s ease-in-out 2s forwards;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }
        
        .splash-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: titleSlide 1s ease-out 0.5s both, titleBubble 4s ease-in-out 2.2s forwards;
        }
        
        .splash-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            animation: subtitleFade 1s ease-out 1s both, subtitleBubble 4s ease-in-out 2.4s forwards;
        }
        
        .splash-particles {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            margin: -100px 0 0 -100px;
            pointer-events: none;
        }
        
        .splash-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: particleFloat 3s ease-in-out infinite;
        }
        
        .splash-particle:nth-child(1) { top: 20%; left: 30%; animation-delay: 0s; }
        .splash-particle:nth-child(2) { top: 40%; left: 70%; animation-delay: 0.3s; }
        .splash-particle:nth-child(3) { top: 60%; left: 20%; animation-delay: 0.6s; }
        .splash-particle:nth-child(4) { top: 80%; left: 60%; animation-delay: 0.9s; }
        .splash-particle:nth-child(5) { top: 10%; left: 80%; animation-delay: 1.2s; }
        .splash-particle:nth-child(6) { top: 70%; left: 40%; animation-delay: 1.5s; }
        .splash-particle:nth-child(7) { top: 30%; left: 10%; animation-delay: 1.8s; }
        .splash-particle:nth-child(8) { top: 50%; left: 90%; animation-delay: 2.1s; }
        
        @keyframes splashPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        @keyframes logoBubble {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            70% { transform: scale(1.2) translateY(-20px); opacity: 0.8; }
            100% { transform: scale(0) translateY(-50px); opacity: 0; }
        }
        
        @keyframes titleSlide {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes titleBubble {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            70% { transform: scale(1.1) translateY(-15px); opacity: 0.7; }
            100% { transform: scale(0) translateY(-40px); opacity: 0; }
        }
        
        @keyframes subtitleFade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 0.8; transform: translateY(0); }
        }
        
        @keyframes subtitleBubble {
            0% { transform: scale(1) translateY(0); opacity: 0.8; }
            70% { transform: scale(1.05) translateY(-10px); opacity: 0.5; }
            100% { transform: scale(0) translateY(-30px); opacity: 0; }
        }
        
        @keyframes particleFloat {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
                opacity: 0.6; 
            }
            50% { 
                transform: translateY(-15px) scale(1.2); 
                opacity: 1; 
            }
        }
        
        .home-screen { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            text-align: center; 
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            animation: float 25s infinite linear;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .particle:nth-child(1) { width: 12px; height: 12px; left: 5%; animation-delay: -0s; animation-duration: 20s; }
        .particle:nth-child(2) { width: 8px; height: 8px; left: 15%; animation-delay: -2s; animation-duration: 18s; }
        .particle:nth-child(3) { width: 16px; height: 16px; left: 25%; animation-delay: -4s; animation-duration: 22s; }
        .particle:nth-child(4) { width: 6px; height: 6px; left: 35%; animation-delay: -6s; animation-duration: 16s; }
        .particle:nth-child(5) { width: 20px; height: 20px; left: 45%; animation-delay: -8s; animation-duration: 24s; }
        .particle:nth-child(6) { width: 10px; height: 10px; left: 55%; animation-delay: -10s; animation-duration: 19s; }
        .particle:nth-child(7) { width: 14px; height: 14px; left: 65%; animation-delay: -12s; animation-duration: 21s; }
        .particle:nth-child(8) { width: 7px; height: 7px; left: 75%; animation-delay: -14s; animation-duration: 17s; }
        .particle:nth-child(9) { width: 18px; height: 18px; left: 85%; animation-delay: -16s; animation-duration: 23s; }
        .particle:nth-child(10) { width: 9px; height: 9px; left: 95%; animation-delay: -18s; animation-duration: 20s; }
        .particle:nth-child(11) { width: 11px; height: 11px; left: 12%; animation-delay: -3s; animation-duration: 19s; }
        .particle:nth-child(12) { width: 15px; height: 15px; left: 28%; animation-delay: -7s; animation-duration: 21s; }
        .particle:nth-child(13) { width: 5px; height: 5px; left: 42%; animation-delay: -11s; animation-duration: 16s; }
        .particle:nth-child(14) { width: 13px; height: 13px; left: 58%; animation-delay: -15s; animation-duration: 22s; }
        .particle:nth-child(15) { width: 8px; height: 8px; left: 72%; animation-delay: -5s; animation-duration: 18s; }
        .particle:nth-child(16) { width: 17px; height: 17px; left: 88%; animation-delay: -9s; animation-duration: 24s; }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            50% {
                transform: translateY(50vh) translateX(20px) rotate(180deg);
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(-20px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .logo { 
            color: white; 
            font-size: clamp(1.8rem, 5vw, 3rem); 
            font-weight: bold; 
            margin-bottom: 15px; 
            text-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            position: relative;
            z-index: 10;
            animation: titleFloat 6s ease-in-out infinite;
        }
        
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .subtitle { 
            color: rgba(255,255,255,0.9); 
            font-size: clamp(1rem, 3vw, 1.2rem); 
            margin-bottom: 40px; 
            position: relative;
            z-index: 10;
            animation: titleFloat 6s ease-in-out infinite 0.5s;
        }
        
        .bubbles-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px;
            max-width: 400px;
            width: 100%;
            position: relative;
            z-index: 10;
        }
        
        .bubble { 
            aspect-ratio: 1;
            min-height: 140px;
            border-radius: 50%; 
            background: rgba(255,255,255,0.15); 
            backdrop-filter: blur(20px); 
            border: 2px solid rgba(255,255,255,0.2); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 15px 45px rgba(0,0,0,0.1), 
                        inset 0 1px 0 rgba(255,255,255,0.2); 
            animation: bubbleFloat 8s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        
        .bubble:nth-child(1) { animation-delay: 0s; }
        .bubble:nth-child(2) { animation-delay: 1s; }
        .bubble:nth-child(3) { animation-delay: 2s; }
        .bubble:nth-child(4) { animation-delay: 3s; }
        
        @keyframes bubbleFloat {
            0%, 100% { 
                transform: translateY(0px) scale(1); 
            }
            25% { 
                transform: translateY(-20px) scale(1.02); 
            }
            50% { 
                transform: translateY(-15px) scale(1.05); 
            }
            75% { 
                transform: translateY(-25px) scale(1.02); 
            }
        }
        
        .bubble::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: radial-gradient(
                ellipse at 30% 30%,
                rgba(255,255,255,0.3) 0%,
                rgba(255,255,255,0.1) 40%,
                transparent 70%
            );
            border-radius: 50%;
            animation: bubbleShine 6s ease-in-out infinite;
            opacity: 0.7;
        }
        
        .bubble::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: conic-gradient(
                from 0deg,
                rgba(255,255,255,0.1),
                rgba(255,255,255,0.3),
                rgba(255,255,255,0.1),
                rgba(255,255,255,0.3),
                rgba(255,255,255,0.1)
            );
            border-radius: 50%;
            animation: bubbleRotate 15s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        @keyframes bubbleShine {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.1) rotate(10deg);
                opacity: 0.9;
            }
        }
        
        @keyframes bubbleRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .bubble:hover::after {
            opacity: 0.6;
        }
        
        .bubble:hover { 
            transform: scale(1.15) translateY(-12px); 
            box-shadow: 0 30px 90px rgba(0,0,0,0.25), 
                        inset 0 1px 0 rgba(255,255,255,0.4),
                        0 0 0 4px rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.25); 
            border-color: rgba(255,255,255,0.4);
        }
        
        .bubble-emoji { 
            font-size: clamp(2rem, 5vw, 3rem); 
            margin-bottom: 8px; 
            animation: emojiPulse 4s ease-in-out infinite;
            position: relative;
            z-index: 2;
        }
        
        @keyframes emojiPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .bubble-text { 
            color: white; 
            font-weight: 600; 
            font-size: clamp(12px, 3vw, 16px); 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            position: relative;
            z-index: 2;
        }
        
        .section-screen { 
            display: none; 
            min-height: 100vh; 
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .section-screen.active { display: block; }
        
        .section-floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .section-floating-particles .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            animation: float 25s infinite linear;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-floating-particles .particle:nth-child(1) { width: 12px; height: 12px; left: 5%; animation-delay: -0s; animation-duration: 20s; }
        .section-floating-particles .particle:nth-child(2) { width: 8px; height: 8px; left: 15%; animation-delay: -2s; animation-duration: 18s; }
        .section-floating-particles .particle:nth-child(3) { width: 16px; height: 16px; left: 25%; animation-delay: -4s; animation-duration: 22s; }
        .section-floating-particles .particle:nth-child(4) { width: 6px; height: 6px; left: 35%; animation-delay: -6s; animation-duration: 16s; }
        .section-floating-particles .particle:nth-child(5) { width: 20px; height: 20px; left: 45%; animation-delay: -8s; animation-duration: 24s; }
        .section-floating-particles .particle:nth-child(6) { width: 10px; height: 10px; left: 55%; animation-delay: -10s; animation-duration: 19s; }
        .section-floating-particles .particle:nth-child(7) { width: 14px; height: 14px; left: 65%; animation-delay: -12s; animation-duration: 21s; }
        .section-floating-particles .particle:nth-child(8) { width: 7px; height: 7px; left: 75%; animation-delay: -14s; animation-duration: 17s; }
        .section-floating-particles .particle:nth-child(9) { width: 18px; height: 18px; left: 85%; animation-delay: -16s; animation-duration: 23s; }
        .section-floating-particles .particle:nth-child(10) { width: 9px; height: 9px; left: 95%; animation-delay: -18s; animation-duration: 20s; }
        .section-floating-particles .particle:nth-child(11) { width: 11px; height: 11px; left: 12%; animation-delay: -3s; animation-duration: 19s; }
        .section-floating-particles .particle:nth-child(12) { width: 15px; height: 15px; left: 28%; animation-delay: -7s; animation-duration: 21s; }
        
        .back-button { 
            position: fixed; 
            top: 15px; 
            left: 15px; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(20px); 
            border: 2px solid rgba(255,255,255,0.3); 
            color: white; 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .back-button:hover { 
            transform: scale(1.1); 
            background: rgba(255,255,255,0.3); 
        }
        
        .section-container { 
            max-width: 600px; 
            margin: 80px auto 40px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(20px); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            position: relative;
            z-index: 10;
        }
        
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 15px;
        }
        
        .month-nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-nav-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .current-month {
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
            min-width: 180px;
            text-align: center;
        }
        
        .section-title { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 25px; 
            font-size: clamp(1.3rem, 4vw, 2rem); 
            font-weight: bold; 
        }
        
        .input-group { 
            margin-bottom: 15px; 
        }
        
        .input-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #2c3e50; 
            font-size: 14px;
        }
        
        .input-group input { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e1e8ed; 
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease; 
            background: white; 
        }
        
        .input-group input:focus { 
            border-color: #667eea; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        
        .custom-expense { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 15px; 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        
        .title-input { 
            flex: 2; 
            min-width: 120px;
            padding: 8px 12px; 
            border: 1px solid #d1d9e6; 
            border-radius: 8px; 
            background: white; 
            font-size: 14px;
        }
        
        .value-input { 
            flex: 1; 
            min-width: 80px;
            padding: 8px 12px; 
            border: 1px solid #d1d9e6; 
            border-radius: 8px; 
            background: white; 
            font-size: 14px;
        }
        
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 13px; 
            white-space: nowrap;
        }
        
        .btn-add { 
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(72, 198, 239, 0.4); 
        }
        
        .btn-add:hover { transform: translateY(-2px); }
        
        .btn-remove { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            color: white; 
            padding: 8px 12px; 
            font-size: 12px; 
            min-width: auto;
        }
        
        .btn-reset { 
            background: linear-gradient(135deg, #ffa726 0%, #ff7043 100%); 
            color: white; 
            margin: 10px 5px;
        }
        
        .btn-export { 
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); 
            color: white; 
            margin: 10px 5px;
        }
        
        .btn-transfer {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin: 10px 5px;
        }
        
        .result-card { 
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            margin: 15px 0; 
            box-shadow: 0 8px 32px rgba(72, 198, 239, 0.3); 
        }
        
        .result-value { 
            font-size: clamp(1.5rem, 4vw, 2.5rem); 
            font-weight: bold; 
            margin-bottom: 6px; 
        }
        
        .result-label { 
            opacity: 0.9; 
            font-size: clamp(0.9rem, 3vw, 1.1rem); 
        }
        
        .week-card { 
            background: rgba(255,255,255,0.9); 
            border-radius: 15px; 
            padding: 15px; 
            margin: 12px 0; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            border-left: 5px solid #667eea; 
        }
        
        .week-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .week-title { 
            font-size: clamp(1rem, 3vw, 1.3rem); 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        .week-budget { 
            font-size: clamp(0.9rem, 3vw, 1.1rem); 
            font-weight: 600; 
            color: #667eea; 
        }
        
        .week-details { 
            display: none; 
            margin-top: 15px; 
        }
        
        .week-details.active { display: block; }
        
        .expense-item { 
            display: flex; 
            gap: 6px; 
            margin: 8px 0; 
            padding: 10px; 
            background: white; 
            border-radius: 10px; 
            border-left: 4px solid #48c6ef; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            align-items: center; 
            flex-wrap: wrap;
        }
        
        .expense-amount { 
            width: 70px; 
            padding: 6px 8px; 
            border: 1px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 14px; 
        }
        
        .expense-desc { 
            flex: 1; 
            min-width: 100px;
            padding: 6px 8px; 
            border: 1px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 13px; 
        }
        
        .expense-category { 
            width: 90px; 
            padding: 6px 8px; 
            border: 1px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 11px; 
        }
        
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin: 15px 0; 
        }
        
        .summary-card { 
            background: white; 
            padding: 15px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
        }
        
        .summary-card h3 { 
            color: #2c3e50; 
            font-size: 12px; 
            margin-bottom: 8px; 
        }
        
        .summary-card .value { 
            font-size: clamp(1.2rem, 3vw, 1.8rem); 
            font-weight: bold; 
            color: #667eea; 
        }
        
        .historical-comparison {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #9c27b0;
        }
        
        .comparison-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .negative { color: #ff6b6b !important; }
        .positive { color: #48c6ef !important; }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .button-row { 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin: 20px 0; 
        }
        
        .week-summary { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px; 
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .section-container { 
                margin: 70px 10px 20px; 
                padding: 15px; 
            }
            
            .custom-expense {
                flex-direction: column;
                align-items: stretch;
            }
            
            .title-input, .value-input {
                flex: none;
                width: 100%;
                margin-bottom: 8px;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .expense-amount, .expense-desc, .expense-category {
                width: 100%;
                margin-bottom: 6px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .button-row .btn {
                flex: 1;
                min-width: 120px;
            }
            
            .week-header {
                flex-direction: column;
                text-align: center;
            }
            
            .month-selector {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">üí∞</div>
            <div class="splash-title">Budget Manager Pro</div>
            <div class="splash-subtitle">Caricamento...</div>
            <div class="splash-particles">
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
            </div>
        </div>
    </div>
    
    <div id="homeScreen" class="screen active">
        <div class="home-screen">
            <div class="floating-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            <div class="logo">Budget Manager Pro</div>
            <div class="subtitle">Gestisci le tue finanze con storico completo</div>
            <div class="bubbles-container">
                <div class="bubble" onclick="goToPage('setupScreen')">
                    <div class="bubble-emoji">‚öôÔ∏è</div>
                    <div class="bubble-text">Configurazione</div>
                </div>
                <div class="bubble" onclick="goToPage('weeklyScreen')">
                    <div class="bubble-emoji">üìÖ</div>
                    <div class="bubble-text">Settimane</div>
                </div>
                <div class="bubble" onclick="goToPage('summaryScreen')">
                    <div class="bubble-emoji">üìä</div>
                    <div class="bubble-text">Riepilogo</div>
                </div>
                <div class="bubble" onclick="goToPage('statsScreen')">
                    <div class="bubble-emoji">üìà</div>
                    <div class="bubble-text">Statistiche</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="setupScreen" class="screen section-screen">
        <button class="back-button" onclick="goToPage('homeScreen')">‚Üê</button>
        <div class="section-container">
            <div class="month-selector">
                <button class="month-nav-btn" onclick="cambiaMese(-1)">‚Äπ</button>
                <div class="current-month" id="currentMonthDisplay"></div>
                <button class="month-nav-btn" onclick="cambiaMese(1)">‚Ä∫</button>
            </div>
            
            <h1 class="section-title">Configurazione</h1>
            <div class="input-group">
                <label>Stipendio Mensile</label>
                <input type="number" id="stipendio" value="2000" onchange="calcola()">
            </div>
            <div class="input-group">
                <label>Risparmi Fissi</label>
                <input type="number" id="risparmi" value="400" onchange="calcola()">
            </div>
            <div id="speseExtra">
                <div class="custom-expense">
                    <input type="text" class="title-input" id="titolo1" placeholder="Es: Auto..." value="Auto" onchange="salva()">
                    <input type="number" class="value-input" id="valore1" value="500" onchange="calcola()">
                    <button class="btn btn-remove" onclick="rimuovi(1)">X</button>
                </div>
            </div>
            <div style="text-align: center; margin: 15px 0;">
                <button class="btn btn-add" onclick="aggiungiNuova()">+ Aggiungi Spesa</button>
            </div>
            <div class="result-card">
                <div class="result-value" id="budgetMensile">‚Ç¨1100</div>
                <div class="result-label">Budget Mensile Disponibile</div>
            </div>
            <div class="result-card">
                <div class="result-value" id="budgetWeek">‚Ç¨275</div>
                <div class="result-label">Budget per Settimana</div>
            </div>
            <div class="button-row">
                <button class="btn btn-reset" onclick="resetMese()">Reset Mese</button>
                <button class="btn btn-export" onclick="esportaMese()">Esporta Mese</button>
            </div>
        </div>
    </div>
    
    <div id="weeklyScreen" class="screen section-screen">
        <button class="back-button" onclick="goToPage('homeScreen')">‚Üê</button>
        <div class="section-container">
            <div class="month-selector">
                <button class="month-nav-btn" onclick="cambiaMese(-1)">‚Äπ</button>
                <div class="current-month" id="currentMonthDisplayWeekly"></div>
                <button class="month-nav-btn" onclick="cambiaMese(1)">‚Ä∫</button>
            </div>
            
            <h1 class="section-title">Gestione Settimanale</h1>
            <div id="weekContainer"></div>
        </div>
    </div>
    
    <div id="summaryScreen" class="screen section-screen">
        <button class="back-button" onclick="goToPage('homeScreen')">‚Üê</button>
        <div class="section-container">
            <div class="month-selector">
                <button class="month-nav-btn" onclick="cambiaMese(-1)">‚Äπ</button>
                <div class="current-month" id="currentMonthDisplaySummary"></div>
                <button class="month-nav-btn" onclick="cambiaMese(1)">‚Ä∫</button>
            </div>
            
            <h1 class="section-title">Riepilogo</h1>
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Stipendio</h3>
                    <div class="value" id="riepilogoStipendio">‚Ç¨2000</div>
                </div>
                <div class="summary-card">
                    <h3>Spese Fisse</h3>
                    <div class="value" id="riepilogoFisse">‚Ç¨900</div>
                </div>
                <div class="summary-card">
                    <h3>Spese Variabili</h3>
                    <div class="value" id="riepilogoVariabili">‚Ç¨0</div>
                </div>
                <div class="summary-card">
                    <h3>Saldo</h3>
                    <div class="value" id="riepilogoSaldo">‚Ç¨1100</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="statsScreen" class="screen section-screen">
        <button class="back-button" onclick="goToPage('homeScreen')">‚Üê</button>
        <div class="section-container">
            <div class="month-selector">
                <button class="month-nav-btn" onclick="cambiaMese(-1)">‚Äπ</button>
                <div class="current-month" id="currentMonthDisplayStats"></div>
                <button class="month-nav-btn" onclick="cambiaMese(1)">‚Ä∫</button>
            </div>
            
            <h1 class="section-title">Statistiche</h1>
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Media Settimanale</h3>
                    <div class="value" id="mediaSpese">‚Ç¨0</div>
                </div>
                <div class="summary-card">
                    <h3>Settimana Top</h3>
                    <div class="value" id="settimanaTop">-</div>
                </div>
                <div class="summary-card">
                    <h3>Settimana Low</h3>
                    <div class="value" id="settimanaLow">-</div>
                </div>
                <div class="summary-card">
                    <h3>Risparmio %</h3>
                    <div class="value" id="percentualeRisparmio">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMonth = new Date();
        let contatore = 1;
        let speseExtra = [1];
        let budgetBase = 275;
        let speseSettimane = { 1: [], 2: [], 3: [], 4: [] };
        let contatoreSpese = 0;
        
        // Array globale per memorizzare tutti i dati delle spese
        window.speseGlobali = {};
        
        const categorie = {
            'alimentari': { nome: 'Alimentari', colore: '#4ade80' },
            'trasporti': { nome: 'Trasporti', colore: '#f59e0b' },
            'svago': { nome: 'Svago', colore: '#8b5cf6' },
            'casa': { nome: 'Casa', colore: '#06b6d4' },
            'salute': { nome: 'Salute', colore: '#ef4444' },
            'altro': { nome: 'Altro', colore: '#6b7280' }
        };
        
        function getMonthKey() {
            return `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function formatMonthDisplay(date) {
            return date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long' });
        }
        
        function aggiornaDisplayMese() {
            const monthText = formatMonthDisplay(currentMonth);
            const displays = ['currentMonthDisplay', 'currentMonthDisplayWeekly', 'currentMonthDisplaySummary', 'currentMonthDisplayStats'];
            displays.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = monthText;
            });
        }
        
        function cambiaMese(direction) {
            // Salva prima di cambiare mese
            salvaDatiCompleti();
            
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            aggiornaDisplayMese();
            
            // Carica i dati del nuovo mese
            caricaMese();
            calcola();
            
            // Aggiorna la schermata corrente
            const currentScreen = document.querySelector('.screen.active').id;
            if (currentScreen === 'weeklyScreen') {
                generaSettimane();
                aggiornaCalcoliSettimane();
            } else if (currentScreen === 'summaryScreen') {
                aggiornaSummary();
            } else if (currentScreen === 'statsScreen') {
                aggiornaStats();
            }
        }
        
        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '0';
        }
        
        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value;
        }
        
        function goToPage(pagina) {
            // Salva prima di cambiare pagina
            salvaDatiCompleti();
            
            // Rimuovi particelle esistenti
            const existingParticles = document.querySelector('.page-particles');
            if (existingParticles) {
                existingParticles.remove();
            }
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(pagina).classList.add('active');
            
            // Aggiungi particelle se non √® la home
            if (pagina !== 'homeScreen') {
                createPageParticles();
            }
            
            if (pagina === 'weeklyScreen') {
                generaSettimane();
                aggiornaCalcoliSettimane();
            } else if (pagina === 'summaryScreen') {
                aggiornaSummary();
            } else if (pagina === 'statsScreen') {
                aggiornaStats();
            }
        }
        
        function createPageParticles() {
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'page-particles';
            particlesContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
            `;
            
            // Crea 12 particelle identiche a quelle della home
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    background: rgba(255, 255, 255, 0.08);
                    border-radius: 50%;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                `;
                
                // Dimensioni e posizioni come nella home
                const sizes = [12, 8, 16, 6, 20, 10, 14, 7, 18, 9, 11, 15];
                const positions = [5, 15, 25, 35, 45, 55, 65, 75, 85, 95, 12, 28];
                const delays = [0, -2, -4, -6, -8, -10, -12, -14, -16, -18, -3, -7];
                const durations = [20, 18, 22, 16, 24, 19, 21, 17, 23, 20, 19, 21];
                
                particle.style.width = sizes[i] + 'px';
                particle.style.height = sizes[i] + 'px';
                particle.style.left = positions[i] + '%';
                particle.style.animation = `float ${durations[i]}s ${delays[i]}s infinite linear`;
                
                particlesContainer.appendChild(particle);
            }
            
            document.body.appendChild(particlesContainer);
        }
        
        function caricaMese() {
            const monthKey = getMonthKey();
            
            try {
                const salvati = localStorage.getItem(`budgetApp_${monthKey}`);
                if (salvati) {
                    const dati = JSON.parse(salvati);
                    console.log('Caricamento mese:', monthKey, dati);
                    
                    // Carica dati base
                    if (dati.stipendio) setValue('stipendio', dati.stipendio);
                    if (dati.risparmi) setValue('risparmi', dati.risparmi);
                    
                    // Ripristina contatori
                    contatore = dati.contatore || 1;
                    contatoreSpese = dati.contatoreSpese || 0;
                    speseSettimane = dati.speseSettimane || { 1: [], 2: [], 3: [], 4: [] };
                    
                    // Carica array globale spese
                    window.speseGlobali = dati.speseDettagliate || {};
                    
                    // Carica spese extra
                    if (dati.speseExtra && dati.speseExtra.length > 0) {
                        speseExtra = [];
                        const container = document.getElementById('speseExtra');
                        container.innerHTML = '';
                        
                        dati.speseExtra.forEach(spesa => {
                            const div = document.createElement('div');
                            div.className = 'custom-expense';
                            div.id = `spesa${spesa.id}`;
                            div.innerHTML = `
                                <input type="text" class="title-input" id="titolo${spesa.id}" value="${spesa.titolo}" onchange="salvaDatiCompleti()">
                                <input type="number" class="value-input" id="valore${spesa.id}" value="${spesa.valore}" onchange="calcola()">
                                <button class="btn btn-remove" onclick="rimuovi(${spesa.id})">X</button>
                            `;
                            container.appendChild(div);
                            speseExtra.push(spesa.id);
                        });
                    } else {
                        resetDatiDefault();
                    }
                    
                    return true;
                } else {
                    resetDatiDefault();
                }
            } catch(e) {
                console.error('Errore caricamento:', e);
                resetDatiDefault();
            }
            return false;
        }
        
        function resetDatiDefault() {
            setValue('stipendio', '0');
            setValue('risparmi', '0');
            
            const container = document.getElementById('speseExtra');
            container.innerHTML = '';
            
            contatore = 0;
            speseExtra = [];
            budgetBase = 0;
            speseSettimane = { 1: [], 2: [], 3: [], 4: [] };
            contatoreSpese = 0;
            window.speseGlobali = {};
        }
        
        function calcola() {
            const stipendio = parseFloat(getValue('stipendio')) || 0;
            const risparmi = parseFloat(getValue('risparmi')) || 0;
            
            let totaleExtra = 0;
            speseExtra.forEach(id => {
                const valore = parseFloat(getValue(`valore${id}`)) || 0;
                totaleExtra += valore;
            });
            
            const speseFisse = risparmi + totaleExtra;
            const budgetDisponibile = stipendio - speseFisse;
            budgetBase = budgetDisponibile > 0 ? budgetDisponibile / 4 : 0;
            
            const budgetMensileEl = document.getElementById('budgetMensile');
            const budgetWeekEl = document.getElementById('budgetWeek');
            
            if (budgetMensileEl) {
                budgetMensileEl.textContent = `‚Ç¨${budgetDisponibile.toFixed(2)}`;
                budgetMensileEl.className = `result-value ${budgetDisponibile < 0 ? 'negative' : ''}`;
            }
            if (budgetWeekEl) {
                budgetWeekEl.textContent = `‚Ç¨${budgetBase.toFixed(2)}`;
                budgetWeekEl.className = `result-value ${budgetBase < 0 ? 'negative' : ''}`;
            }
            
            aggiornaCalcoliSettimane();
            salvaDatiCompleti();
        }
        
        function generaSettimane() {
            const container = document.getElementById('weekContainer');
            container.innerHTML = '';
            
            for (let settimana = 1; settimana <= 4; settimana++) {
                const weekCard = document.createElement('div');
                weekCard.className = 'week-card';
                weekCard.innerHTML = `
                    <div class="week-header">
                        <div class="week-title">Settimana ${settimana}</div>
                        <div class="week-budget" id="weekBudget${settimana}">‚Ç¨${budgetBase.toFixed(2)}</div>
                    </div>
                    <div class="week-summary">
                        <span><strong>Speso:</strong> <span id="weekSpent${settimana}" class="positive">‚Ç¨0</span></span>
                        <span><strong>Saldo:</strong> <span id="weekBalance${settimana}" class="positive">‚Ç¨${budgetBase.toFixed(2)}</span></span>
                    </div>
                    <button class="btn btn-add" onclick="toggleWeek(${settimana})" style="width: 100%;">Gestisci Spese</button>
                    <div id="week${settimana}" class="week-details">
                        <div id="expenses${settimana}"></div>
                        <div style="text-align: center; margin-top: 12px;">
                            <button class="btn btn-add" onclick="aggiungiSpesaWeek(${settimana})">+ Aggiungi Spesa</button>
                            <button class="btn btn-transfer" onclick="trasferisciSaldo(${settimana})" style="margin-left: 10px;">üí∞ Trasferisci Saldo</button>
                        </div>
                    </div>
                `;
                container.appendChild(weekCard);
                
                // Carica le spese salvate per questa settimana
                caricaSpeseSalvate(settimana);
            }
        }
        
        function caricaSpeseSalvate(settimana) {
            console.log(`Caricando spese per settimana ${settimana}`);
            console.log('Array globale corrente:', window.speseGlobali);
            console.log('Spese settimane:', speseSettimane);
            
            if (speseSettimane[settimana] && speseSettimane[settimana].length > 0) {
                speseSettimane[settimana].forEach(spesaId => {
                    const spesaData = window.speseGlobali[spesaId];
                    if (spesaData) {
                        console.log(`Caricando spesa ${spesaId}:`, spesaData);
                        creaNuovaSpesa(settimana, spesaId, spesaData);
                    } else {
                        console.log(`Dati mancanti per spesa ${spesaId}, creo vuota`);
                        creaNuovaSpesa(settimana, spesaId, { importo: '0', desc: '', categoria: 'altro' });
                    }
                });
            }
        }
        
        function creaNuovaSpesa(settimana, spesaId, spesaData = null) {
            const container = document.getElementById(`expenses${settimana}`);
            if (!container) {
                console.error(`Container expenses${settimana} non trovato`);
                return;
            }
            
            const data = spesaData || { importo: '0', desc: '', categoria: 'altro' };
            const categoria = categorie[data.categoria] || categorie['altro'];
            
            const div = document.createElement('div');
            div.className = 'expense-item';
            div.id = `exp_${spesaId}`;
            div.style.borderLeftColor = categoria.colore;
            div.innerHTML = `
                <input type="number" class="expense-amount" id="amt_${spesaId}" placeholder="‚Ç¨" value="${data.importo}" oninput="aggiornaSpesaGlobale('${spesaId}'); ricalcolaSettimana();" step="0.01" min="0">
                <input type="text" class="expense-desc" id="desc_${spesaId}" placeholder="Descrizione..." value="${data.desc}" oninput="aggiornaSpesaGlobale('${spesaId}');">
                <select class="expense-category" id="cat_${spesaId}" onchange="cambiaCategoria('${spesaId}'); aggiornaSpesaGlobale('${spesaId}');">
                    ${Object.keys(categorie).map(key => `<option value="${key}" ${key === data.categoria ? 'selected' : ''}>${categorie[key].nome}</option>`).join('')}
                </select>
                <button class="btn btn-remove" onclick="rimuoviSpesaWeek('${spesaId}', ${settimana})" title="Elimina spesa">X</button>
            `;
            container.appendChild(div);
            
            console.log(`Spesa ${spesaId} creata nel DOM per settimana ${settimana}`);
        }
        
        function aggiornaSpesaGlobale(spesaId) {
            const importo = getValue(`amt_${spesaId}`) || '0';
            const desc = getValue(`desc_${spesaId}`) || '';
            const categoria = getValue(`cat_${spesaId}`) || 'altro';
            
            window.speseGlobali[spesaId] = { importo, desc, categoria };
            console.log(`Aggiornata spesa globale ${spesaId}:`, window.speseGlobali[spesaId]);
            
            // Salvataggio immediato per debug
            salvaDatiCompleti();
        }
        
        function aggiungiSpesaWeek(settimana) {
            contatoreSpese++;
            const spesaId = `w${settimana}_${contatoreSpese}`;
            
            console.log(`Aggiungendo nuova spesa: ${spesaId} per settimana ${settimana}`);
            
            // Aggiungi all'array delle settimane
            if (!speseSettimane[settimana]) {
                speseSettimane[settimana] = [];
            }
            speseSettimane[settimana].push(spesaId);
            
            // Crea la spesa vuota nell'array globale
            window.speseGlobali[spesaId] = { importo: '0', desc: '', categoria: 'altro' };
            
            // Crea l'elemento DOM
            creaNuovaSpesa(settimana, spesaId);
            
            // Salva immediatamente
            salvaDatiCompleti();
            
            console.log('Nuove speseSettimane:', speseSettimane);
            console.log('Nuovo array globale:', window.speseGlobali);
        }
        
        function rimuoviSpesaWeek(spesaId, settimana) {
            console.log(`Rimozione spesa ${spesaId} da settimana ${settimana}`);
            
            const div = document.getElementById(`exp_${spesaId}`);
            if (!div) return;
            
            div.style.transition = 'all 0.3s ease';
            div.style.opacity = '0.5';
            div.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                // Rimuovi dal DOM
                div.remove();
                
                // Rimuovi dall'array delle settimane
                if (speseSettimane[settimana]) {
                    speseSettimane[settimana] = speseSettimane[settimana].filter(id => id !== spesaId);
                }
                
                // Rimuovi dall'array globale
                delete window.speseGlobali[spesaId];
                
                console.log(`Spesa ${spesaId} rimossa. Nuove speseSettimane:`, speseSettimane);
                console.log('Nuovo array globale:', window.speseGlobali);
                
                // Ricalcola e salva
                aggiornaCalcoliSettimane();
                salvaDatiCompleti();
            }, 300);
        }
        
        function cambiaCategoria(spesaId) {
            const selectEl = document.getElementById(`cat_${spesaId}`);
            const expenseEl = document.getElementById(`exp_${spesaId}`);
            
            if (selectEl && expenseEl) {
                const nuovaCategoria = selectEl.value;
                const categoria = categorie[nuovaCategoria];
                expenseEl.style.borderLeftColor = categoria.colore;
            }
        }
        
        function toggleWeek(settimana) {
            const weekEl = document.getElementById(`week${settimana}`);
            if (weekEl) {
                weekEl.classList.toggle('active');
            }
        }
        
        function ricalcolaSettimana() {
            aggiornaCalcoliSettimane();
        }
        
        function calcolaTotaleSettimana(settimana) {
            let totale = 0;
            
            if (speseSettimane[settimana]) {
                speseSettimane[settimana].forEach(spesaId => {
                    const spesaData = window.speseGlobali[spesaId];
                    if (spesaData) {
                        const importo = parseFloat(spesaData.importo) || 0;
                        totale += importo;
                    }
                });
            }
            
            return totale;
        }
        
        function aggiornaCalcoliSettimane() {
            if (!budgetBase || budgetBase <= 0) return;
            
            // Assicurati che l'oggetto trasferimenti esista
            if (!window.speseGlobali.trasferimenti) {
                window.speseGlobali.trasferimenti = {};
            }
            
            // Calcola tutte le spese una volta
            const spese = [];
            for (let i = 1; i <= 4; i++) {
                spese[i] = calcolaTotaleSettimana(i);
            }
            
            let deficitAccumulato = 0;
            
            for (let settimana = 1; settimana <= 4; settimana++) {
                // Budget base + eventuali trasferimenti manuali ricevuti - deficit accumulato dalle settimane precedenti
                let budgetDisponibile = budgetBase + getTrasferimentiRicevuti(settimana) - deficitAccumulato;
                
                const speso = spese[settimana];
                const trasferito = getSaldoTrasferito(settimana);
                
                // Il saldo √® budget disponibile meno speso meno trasferito manualmente
                const saldo = budgetDisponibile - speso - trasferito;
                
                // Se questa settimana va in deficit, accumulalo per la prossima
                if (saldo < 0) {
                    deficitAccumulato = Math.abs(saldo);
                } else {
                    deficitAccumulato = 0; // Reset del deficit se questa settimana √® in pareggio/surplus
                }
                
                // Aggiorna l'interfaccia
                const weekBudgetEl = document.getElementById(`weekBudget${settimana}`);
                const weekSpentEl = document.getElementById(`weekSpent${settimana}`);
                const weekBalanceEl = document.getElementById(`weekBalance${settimana}`);
                
                if (weekBudgetEl) {
                    let testoBudget = `‚Ç¨${budgetDisponibile.toFixed(2)}`;
                    if (getTrasferimentiRicevuti(settimana) > 0) {
                        testoBudget += ` (+‚Ç¨${getTrasferimentiRicevuti(settimana).toFixed(2)})`;
                    }
                    if (settimana > 1 && (budgetDisponibile < budgetBase + getTrasferimentiRicevuti(settimana))) {
                        const deficit = budgetBase + getTrasferimentiRicevuti(settimana) - budgetDisponibile;
                        testoBudget += ` (-‚Ç¨${deficit.toFixed(2)} deficit)`;
                    }
                    weekBudgetEl.innerHTML = testoBudget;
                    weekBudgetEl.className = `week-budget ${budgetDisponibile !== budgetBase ? (budgetDisponibile > budgetBase ? 'positive' : 'negative') : ''}`;
                }
                
                if (weekSpentEl) {
                    let testoSpeso = `‚Ç¨${speso.toFixed(2)}`;
                    if (trasferito > 0) {
                        testoSpeso += ` (+‚Ç¨${trasferito.toFixed(2)} trasf.)`;
                    }
                    weekSpentEl.innerHTML = testoSpeso;
                    weekSpentEl.className = (speso + trasferito) > budgetDisponibile ? 'negative' : 'positive';
                }
                
                if (weekBalanceEl) {
                    weekBalanceEl.textContent = `‚Ç¨${saldo.toFixed(2)}`;
                    weekBalanceEl.className = saldo < 0 ? 'negative' : 'positive';
                }
                
                // Aggiorna il pulsante di trasferimento - mostra solo se c'√® saldo positivo DOPO le spese
                const transferBtn = document.querySelector(`#week${settimana} .btn-transfer`);
                if (transferBtn) {
                    const saldoDisponibile = budgetDisponibile - speso; // Saldo prima dei trasferimenti manuali
                    if (settimana >= 4 || saldoDisponibile <= 0) {
                        transferBtn.style.display = 'none';
                    } else {
                        transferBtn.style.display = 'inline-block';
                        transferBtn.textContent = `üí∞ Trasferisci ‚Ç¨${saldoDisponibile.toFixed(2)}`;
                    }
                }
            }
        }
        
        function getTrasferimentiRicevuti(settimana) {
            let ricevuti = 0;
            
            if (window.speseGlobali.trasferimenti) {
                // Trasferimenti manuali dalla settimana precedente
                const keyManuale = `w${settimana - 1}_to_w${settimana}`;
                if (window.speseGlobali.trasferimenti[keyManuale]) {
                    ricevuti += window.speseGlobali.trasferimenti[keyManuale];
                }
            }
            
            return ricevuti;
        }
        
        function aggiungiNuova() {
            contatore++;
            const id = contatore;
            
            const div = document.createElement('div');
            div.className = 'custom-expense';
            div.id = `spesa${id}`;
            div.innerHTML = `
                <input type="text" class="title-input" id="titolo${id}" placeholder="Es: Affitto, Auto..." onchange="salvaDatiCompleti()">
                <input type="number" class="value-input" id="valore${id}" value="0" onchange="calcola()">
                <button class="btn btn-remove" onclick="rimuovi(${id})">X</button>
            `;
            
            document.getElementById('speseExtra').appendChild(div);
            speseExtra.push(id);
            aggiornaInterfacciaSpese();
            calcola();
        }
        
        function aggiornaInterfacciaSpese() {
            const container = document.getElementById('speseExtra');
            const addButton = document.querySelector('.btn-add');
            
            if (speseExtra.length === 0) {
                // Mostra messaggio se non ci sono spese
                if (!document.getElementById('noSpeseMessage')) {
                    const messageDiv = document.createElement('div');
                    messageDiv.id = 'noSpeseMessage';
                    messageDiv.style.cssText = `
                        text-align: center;
                        padding: 20px;
                        color: #666;
                        font-style: italic;
                        background: rgba(102, 126, 234, 0.1);
                        border-radius: 15px;
                        margin: 10px 0;
                    `;
                    messageDiv.innerHTML = 'üìù Nessuna spesa fissa configurata<br><small>Clicca il pulsante sotto per aggiungerne una</small>';
                    container.appendChild(messageDiv);
                }
            } else {
                // Rimuovi il messaggio se ci sono spese
                const message = document.getElementById('noSpeseMessage');
                if (message) {
                    message.remove();
                }
            }
        }
        
        function rimuovi(id) {
            const div = document.getElementById(`spesa${id}`);
            if (div) {
                div.style.transition = 'all 0.3s ease';
                div.style.opacity = '0.3';
                div.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    div.remove();
                    speseExtra = speseExtra.filter(item => item !== id);
                    aggiornaInterfacciaSpese();
                    calcola();
                }, 300);
            }
        }
        
        function aggiornaSummary() {
            const stipendio = parseFloat(getValue('stipendio')) || 0;
            let speseFisse = parseFloat(getValue('risparmi')) || 0;
            
            speseExtra.forEach(id => {
                speseFisse += parseFloat(getValue(`valore${id}`)) || 0;
            });
            
            let speseVariabili = 0;
            for (let settimana = 1; settimana <= 4; settimana++) {
                speseVariabili += calcolaTotaleSettimana(settimana);
            }
            
            const saldo = stipendio - speseFisse - speseVariabili;
            
            const riepilogoStipendioEl = document.getElementById('riepilogoStipendio');
            const riepilogoFisseEl = document.getElementById('riepilogoFisse');
            const riepilogoVariabiliEl = document.getElementById('riepilogoVariabili');
            const riepilogoSaldoEl = document.getElementById('riepilogoSaldo');
            
            if (riepilogoStipendioEl) riepilogoStipendioEl.textContent = `‚Ç¨${stipendio.toFixed(2)}`;
            if (riepilogoFisseEl) riepilogoFisseEl.textContent = `‚Ç¨${speseFisse.toFixed(2)}`;
            if (riepilogoVariabiliEl) riepilogoVariabiliEl.textContent = `‚Ç¨${speseVariabili.toFixed(2)}`;
            if (riepilogoSaldoEl) {
                riepilogoSaldoEl.textContent = `‚Ç¨${saldo.toFixed(2)}`;
                riepilogoSaldoEl.className = `value ${saldo < 0 ? 'negative' : 'positive'}`;
            }
        }
        
        function aggiornaStats() {
            const spese = [];
            for (let i = 1; i <= 4; i++) {
                spese.push(calcolaTotaleSettimana(i));
            }
            
            const media = spese.reduce((a, b) => a + b, 0) / 4;
            const max = Math.max(...spese);
            const min = Math.min(...spese);
            
            const stipendio = parseFloat(getValue('stipendio')) || 0;
            const risparmi = parseFloat(getValue('risparmi')) || 0;
            const percentuale = stipendio > 0 ? ((risparmi / stipendio) * 100) : 0;
            
            const mediaSpesaEl = document.getElementById('mediaSpese');
            const settimanaTopEl = document.getElementById('settimanaTop');
            const settimanaLowEl = document.getElementById('settimanaLow');
            const percentualeRisparmioEl = document.getElementById('percentualeRisparmio');
            
            if (mediaSpesaEl) mediaSpesaEl.textContent = `‚Ç¨${media.toFixed(2)}`;
            if (settimanaTopEl) settimanaTopEl.textContent = max > 0 ? `Sett. ${spese.indexOf(max) + 1}` : '-';
            if (settimanaLowEl) settimanaLowEl.textContent = min >= 0 ? `Sett. ${spese.indexOf(min) + 1}` : '-';
            if (percentualeRisparmioEl) percentualeRisparmioEl.textContent = `${percentuale.toFixed(1)}%`;
        }
        
        function resetMese() {
            if (confirm('Sei sicuro di voler resettare tutti i dati del mese corrente?')) {
                resetDatiDefault();
                calcola();
                salvaDatiCompleti();
                alert('Mese resettato!');
            }
        }
        
        function esportaMese() {
            const meseCorrente = formatMonthDisplay(currentMonth);
            const stipendio = parseFloat(getValue('stipendio')) || 0;
            let speseFisse = parseFloat(getValue('risparmi')) || 0;
            
            speseExtra.forEach(id => {
                const valore = parseFloat(getValue(`valore${id}`)) || 0;
                speseFisse += valore;
            });
            
            let speseVariabili = 0;
            let dettaglioSettimane = '';
            
            for (let settimana = 1; settimana <= 4; settimana++) {
                const totaleSettimana = calcolaTotaleSettimana(settimana);
                speseVariabili += totaleSettimana;
                dettaglioSettimane += `\n\nSETTIMANA ${settimana}: EUR${totaleSettimana.toFixed(2)}`;
                
                // Aggiungi dettaglio spese per ogni settimana
                if (speseSettimane[settimana] && speseSettimane[settimana].length > 0) {
                    dettaglioSettimane += '\n  SPESE DETTAGLIATE:';
                    speseSettimane[settimana].forEach(spesaId => {
                        const spesaData = window.speseGlobali[spesaId];
                        if (spesaData) {
                            const importo = parseFloat(spesaData.importo) || 0;
                            const desc = spesaData.desc || 'Senza descrizione';
                            const categoria = categorie[spesaData.categoria]?.nome || 'Altro';
                            
                            if (importo > 0) {
                                dettaglioSettimane += `\n  - ${desc} (${categoria}): EUR${importo.toFixed(2)}`;
                            }
                        }
                    });
                } else {
                    dettaglioSettimane += '\n  Nessuna spesa registrata';
                }
            }
            
            const saldoFinale = stipendio - speseFisse - speseVariabili;
            
            const report = `BUDGET MANAGER PRO - REPORT ${meseCorrente.toUpperCase()}
========================================================
Data: ${new Date().toLocaleString('it-IT')}

RIEPILOGO MENSILE
Stipendio mensile: EUR${stipendio.toFixed(2)}
Risparmi fissi: EUR${parseFloat(getValue('risparmi')).toFixed(2)}

SPESE FISSE:
${speseExtra.map(id => {
    const titolo = getValue(`titolo${id}`) || 'Spesa';
    const valore = parseFloat(getValue(`valore${id}`)) || 0;
    return `- ${titolo}: EUR${valore.toFixed(2)}`;
}).join('\n')}

Totale spese fisse: EUR${speseFisse.toFixed(2)}
Totale spese variabili: EUR${speseVariabili.toFixed(2)}
SALDO FINALE: EUR${saldoFinale.toFixed(2)}

DETTAGLIO SETTIMANALE:${dettaglioSettimane}

STATISTICHE
Percentuale risparmio: ${stipendio > 0 ? ((parseFloat(getValue('risparmi')) / stipendio) * 100).toFixed(1) : 0}%
Budget settimanale medio: EUR${budgetBase.toFixed(2)}
Media spese settimanali: EUR${(speseVariabili / 4).toFixed(2)}

CATEGORIE PIU' UTILIZZATE:
${generaStatisticheCategorie()}
========================================================
Generato da Budget Manager Pro
`;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Budget_${getMonthKey()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert(`Report dettagliato per ${meseCorrente} esportato!`);
        }
        
        function generaStatisticheCategorie() {
            const categorieStats = {};
            
            for (let settimana = 1; settimana <= 4; settimana++) {
                if (speseSettimane[settimana]) {
                    speseSettimane[settimana].forEach(spesaId => {
                        const spesaData = window.speseGlobali[spesaId];
                        if (spesaData) {
                            const categoria = spesaData.categoria || 'altro';
                            const importo = parseFloat(spesaData.importo) || 0;
                            
                            if (importo > 0) {
                                if (!categorieStats[categoria]) {
                                    categorieStats[categoria] = 0;
                                }
                                categorieStats[categoria] += importo;
                            }
                        }
                    });
                }
            }
            
            const sortedCategorie = Object.entries(categorieStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (sortedCategorie.length === 0) {
                return 'Nessuna spesa registrata';
            }
            
            return sortedCategorie.map(([categoria, totale]) => {
                const nomeCategoria = categorie[categoria]?.nome || 'Altro';
                return `- ${nomeCategoria}: EUR${totale.toFixed(2)}`;
            }).join('\n');
        }
        
        function salvaDatiCompleti() {
            const monthKey = getMonthKey();
            console.log('=== INIZIO SALVATAGGIO ===');
            console.log('Chiave mese:', monthKey);
            console.log('Spese globali da salvare:', window.speseGlobali);
            console.log('Spese settimane da salvare:', speseSettimane);
            
            const dati = {
                versione: '3.1',
                meseChiave: monthKey,
                stipendio: getValue('stipendio'),
                risparmi: getValue('risparmi'),
                speseExtra: [],
                contatore: contatore,
                speseSettimane: { ...speseSettimane },
                speseDettagliate: { ...window.speseGlobali },
                contatoreSpese: contatoreSpese,
                timestamp: new Date().toISOString()
            };
            
            // Salva le spese extra
            speseExtra.forEach(id => {
                const titolo = getValue(`titolo${id}`);
                const valore = getValue(`valore${id}`);
                dati.speseExtra.push({ id, titolo, valore });
            });
            
            try {
                const datiString = JSON.stringify(dati);
                console.log('Stringa JSON da salvare (primi 500 caratteri):', datiString.substring(0, 500));
                
                localStorage.setItem(`budgetApp_${monthKey}`, datiString);
                
                // Verifica immediata del salvataggio
                const verificaSalvataggio = localStorage.getItem(`budgetApp_${monthKey}`);
                if (verificaSalvataggio) {
                    const datiVerifica = JSON.parse(verificaSalvataggio);
                    console.log('‚úì SALVATAGGIO RIUSCITO! Spese dettagliate salvate:', Object.keys(datiVerifica.speseDettagliate).length);
                    console.log('‚úì Spese settimane salvate:', datiVerifica.speseSettimane);
                    return true;
                } else {
                    console.error('‚úó ERRORE: Dati non trovati dopo il salvataggio!');
                    return false;
                }
            } catch(e) {
                console.error('‚úó ERRORE salvataggio:', e);
                console.error('Dimensione dati:', JSON.stringify(dati).length, 'caratteri');
                return false;
            }
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INIZIALIZZAZIONE APP ===');
            
            // Gestione splash screen
            showSplashScreen();
            
            // Verifica spazio localStorage
            try {
                const testKey = 'test_storage_' + Date.now();
                const testData = 'x'.repeat(1000);
                localStorage.setItem(testKey, testData);
                localStorage.removeItem(testKey);
                console.log('‚úì LocalStorage funzionante');
            } catch(e) {
                console.error('‚úó Problema con localStorage:', e);
                alert('Attenzione: Problemi con il salvataggio dati. Svuota la cache del browser.');
            }
            
            // Controlla dati esistenti
            console.log('Tutti i dati localStorage per budget:', Object.keys(localStorage).filter(k => k.startsWith('budgetApp_')));
            
            // Inizializza l'array globale
            window.speseGlobali = {};
            
            aggiornaDisplayMese();
            caricaMese();
            calcola();
            
            console.log('App inizializzata. Array globale:', window.speseGlobali);
            console.log('Spese settimane:', speseSettimane);
            
            // Test di salvataggio
            console.log('=== TEST SALVATAGGIO INIZIALE ===');
            salvaDatiCompleti();
            
            // Registra Service Worker per PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registrato con successo:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Errore registrazione Service Worker:', error);
                    });
            }
        });
        
        function showSplashScreen() {
            const splash = document.getElementById('splashScreen');
            const homeScreen = document.getElementById('homeScreen');
            
            // Nascondi la home inizialmente
            homeScreen.style.opacity = '0';
            
            // Controlla se l'app √® stata avviata come PWA
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            // Riduce il tempo se √® PWA per evitare sovrapposizione
            const splashDuration = isStandalone ? 1500 : 3000;
            
            // Dopo il tempo stabilito, inizia l'animazione di uscita
            setTimeout(() => {
                // Fase 1: Gli elementi si trasformano in bolle
                setTimeout(() => {
                    // Fase 2: Fade out della splash screen
                    splash.classList.add('fade-out');
                    
                    // Fase 3: Mostra la home screen con animazione
                    setTimeout(() => {
                        splash.style.display = 'none';
                        homeScreen.style.opacity = '1';
                        homeScreen.style.transition = 'opacity 1s ease-in';
                        
                        // Anima l'entrata degli elementi della home
                        animateHomeEntrance();
                    }, 500);
                }, 100);
            }, splashDuration);
        }
        
        function animateHomeEntrance() {
            const logo = document.querySelector('.home-screen .logo');
            const subtitle = document.querySelector('.home-screen .subtitle');
            const bubbles = document.querySelectorAll('.home-screen .bubble');
            
            // Anima logo
            if (logo) {
                logo.style.opacity = '0';
                logo.style.transform = 'translateY(30px) scale(0.8)';
                logo.style.transition = 'all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                setTimeout(() => {
                    logo.style.opacity = '1';
                    logo.style.transform = 'translateY(0) scale(1)';
                }, 200);
            }
            
            // Anima sottotitolo
            if (subtitle) {
                subtitle.style.opacity = '0';
                subtitle.style.transform = 'translateY(20px)';
                subtitle.style.transition = 'all 0.8s ease-out';
                
                setTimeout(() => {
                    subtitle.style.opacity = '1';
                    subtitle.style.transform = 'translateY(0)';
                }, 400);
            }
            
            // Anima le bolle una per una
            bubbles.forEach((bubble, index) => {
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0.5) translateY(50px)';
                bubble.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                setTimeout(() => {
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'scale(1) translateY(0)';
                }, 600 + (index * 150));
            });
        }
        
        // Salvataggio automatico prima di chiudere
        window.addEventListener('beforeunload', function() {
            console.log('Salvataggio prima di chiudere...');
            salvaDatiCompleti();
        });
        
        // Salvataggio quando l'app va in background
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('App in background, salvataggio...');
                salvaDatiCompleti();
            }
        });
        
        function trasferisciSaldo(settimana) {
            // Non pu√≤ trasferire dalla settimana 4
            if (settimana >= 4) {
                alert('Non √® possibile trasferire il saldo dalla settimana 4.');
                return;
            }
            
            // Calcola il saldo attuale della settimana
            const spesoSettimana = calcolaTotaleSettimana(settimana);
            const budgetDisponibile = getBudgetDisponibileSettimana(settimana);
            const saldo = budgetDisponibile - spesoSettimana;
            
            if (saldo <= 0) {
                alert('Non ci sono fondi rimanenti da trasferire da questa settimana.');
                return;
            }
            
            const conferma = confirm(`Trasferire ‚Ç¨${saldo.toFixed(2)} dalla Settimana ${settimana} alla Settimana ${settimana + 1}?`);
            
            if (conferma) {
                // Salva il trasferimento nei dati
                if (!window.speseGlobali.trasferimenti) {
                    window.speseGlobali.trasferimenti = {};
                }
                
                const keyTrasferimento = `w${settimana}_to_w${settimana + 1}`;
                window.speseGlobali.trasferimenti[keyTrasferimento] = saldo;
                
                // Aggiorna i calcoli
                aggiornaCalcoliSettimane();
                salvaDatiCompleti();
                
                alert(`‚Ç¨${saldo.toFixed(2)} trasferiti con successo dalla Settimana ${settimana} alla Settimana ${settimana + 1}!`);
            }
        }
        
        function getBudgetDisponibileSettimana(settimana) {
            let budget = budgetBase;
            
            // Aggiungi eventuali trasferimenti ricevuti
            if (window.speseGlobali.trasferimenti) {
                Object.keys(window.speseGlobali.trasferimenti).forEach(key => {
                    if (key === `w${settimana - 1}_to_w${settimana}`) {
                        budget += window.speseGlobali.trasferimenti[key];
                    }
                });
            }
            
            return budget;
        }
        
        function getSaldoTrasferito(settimana) {
            let trasferito = 0;
            
            if (window.speseGlobali.trasferimenti) {
                const key = `w${settimana}_to_w${settimana + 1}`;
                if (window.speseGlobali.trasferimenti[key]) {
                    trasferito = window.speseGlobali.trasferimenti[key];
                }
            }
            
            return trasferito;
        }
        
        function debugLocalStorage() {
            console.log('=== DEBUG LOCALSTORAGE ===');
            const monthKey = getMonthKey();
            const salvati = localStorage.getItem(`budgetApp_${monthKey}`);
            
            if (salvati) {
                const dati = JSON.parse(salvati);
                console.log('Dati trovati per', monthKey, ':', dati);
                console.log('Spese dettagliate:', dati.speseDettagliate);
                console.log('Spese settimane:', dati.speseSettimane);
                console.log('Trasferimenti:', dati.speseDettagliate?.trasferimenti);
            } else {
                console.log('Nessun dato trovato per', monthKey);
            }
            
            console.log('Tutte le chiavi budget:', Object.keys(localStorage).filter(k => k.startsWith('budgetApp_')));
            console.log('Stato attuale app:');
            console.log('- window.speseGlobali:', window.speseGlobali);
            console.log('- speseSettimane:', speseSettimane);
        }
        
        // Aggiungi al window per debug dalla console
        window.debugLocalStorage = debugLocalStorage;
        window.salvaDatiCompleti = salvaDatiCompleti;
        
        // Salvataggio automatico ogni 30 secondi
        setInterval(function() {
            console.log('Salvataggio automatico...');
            salvaDatiCompleti();
        }, 30000);
    </script>
</body>
</html>
